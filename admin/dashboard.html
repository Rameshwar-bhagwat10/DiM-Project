<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Moungiri Store</title>
    <link rel="stylesheet" href="admin.css">
    <script src="../config.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="header-left">
                <h1 class="dashboard-title">üè™ Moungiri Admin Dashboard</h1>
                <div class="user-info">
                    <span class="welcome-text">Welcome, <span id="admin-username">Admin</span></span>
                    <span class="session-info" id="session-info">Session active</span>
                </div>
            </div>
            <div class="header-right">
                <div class="session-timer" id="session-timer">
                    <span class="timer-icon">‚è∞</span>
                    <span id="timer-display">2:00:00</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <span class="logout-icon">üö™</span>
                    <span>Logout</span>
                </button>
            </div>
        </header>

        <main class="dashboard-content">
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-products">0</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="available-products">0</div>
                    <div class="stat-label">Available Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="out-of-stock">0</div>
                    <div class="stat-label">Out of Stock</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="categories-count">4</div>
                    <div class="stat-label">Categories</div>
                </div>
            </div>

            <section class="dashboard-section">
                <h2 class="section-title">Add New Product</h2>
                <form id="add-product-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-name">Product Name *</label>
                            <input type="text" id="product-name" name="name" placeholder="e.g., Rice (1kg)" required>
                        </div>
                        <div class="form-group">
                            <label for="product-price">Base Price (‚Çπ) *</label>
                            <input type="number" id="product-price" name="price" min="0" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label for="product-category">Category *</label>
                            <select id="product-category" name="category" required>
                                <option value="">Select Category</option>
                                <option value="grocery">Grocery</option>
                                <option value="snacks">Snacks</option>
                                <option value="household">Household</option>
                                <option value="beverages">Beverages</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-image">Product Image URL</label>
                            <input type="url" id="product-image" name="imageUrl" placeholder="https://images.unsplash.com/photo-...">
                            <small class="form-help">Enter a direct image URL (optional)</small>
                        </div>
                        <div class="form-group">
                            <label for="product-description">Description</label>
                            <textarea id="product-description" name="description" rows="2" placeholder="Brief product description..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="product-status">Availability Status</label>
                            <select id="product-status" name="available">
                                <option value="true">Available</option>
                                <option value="false">Out of Stock</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">Price Variants (Optional)</h3>
                        <div id="price-variants-container">
                            <div class="variant-row">
                                <div class="form-group">
                                    <label>Size/Quantity</label>
                                    <input type="text" name="variant-size" placeholder="e.g., 500g, 1kg, Small Pack">
                                </div>
                                <div class="form-group">
                                    <label>Price (‚Çπ)</label>
                                    <input type="number" name="variant-price" min="0" step="0.01" placeholder="0.00">
                                </div>
                                <button type="button" class="btn-remove-variant" onclick="removeVariant(this)">√ó</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addVariant()">+ Add Price Variant</button>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Add Product</button>
                        <button type="button" class="btn btn-secondary" onclick="previewProduct()">Preview</button>
                        <button type="reset" class="btn btn-outline">Clear Form</button>
                    </div>
                </form>
            </section>

            <section class="dashboard-section">
                <h2 class="section-title">Product Management</h2>
                <div class="products-container">
                    <table class="products-table" id="products-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Category</th>
                                <th>Variants</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                    <div id="no-products-admin" class="empty-state" style="display: none;">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No Products Found</h3>
                        <p>Add your first product using the form above</p>
                    </div>
                </div>
            </section>

            <section class="dashboard-section">
                <h2 class="section-title">Quick Actions</h2>
                <div class="form-row">
                    <button class="btn" onclick="exportProducts()">Export Products</button>
                    <button class="btn btn-danger" onclick="clearAllProducts()">Clear All Products</button>
                    <button class="btn" onclick="resetToDefaults()">Reset to Defaults</button>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Enhanced Authentication & Session Management
        function validateSession() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            const sessionToken = sessionStorage.getItem('sessionToken');
            const loginTime = parseInt(sessionStorage.getItem('loginTime') || '0');
            const adminUser = sessionStorage.getItem('adminUser');
            const SESSION_DURATION = 2 * 60 * 60 * 1000; // 2 hours
            
            if (isLoggedIn !== 'true' || !sessionToken || !loginTime || !adminUser) {
                redirectToLogin('Invalid session');
                return false;
            }
            
            const sessionAge = Date.now() - loginTime;
            if (sessionAge >= SESSION_DURATION) {
                redirectToLogin('Session expired');
                return false;
            }
            
            // Update UI with user info
            document.getElementById('admin-username').textContent = adminUser;
            startSessionTimer(SESSION_DURATION - sessionAge);
            
            return true;
        }

        function redirectToLogin(reason) {
            sessionStorage.clear();
            alert(reason + '. Please login again.');
            window.location.href = 'admin.html';
        }

        function startSessionTimer(remainingTime) {
            const timerDisplay = document.getElementById('timer-display');
            const sessionInfo = document.getElementById('session-info');
            
            function updateTimer() {
                remainingTime -= 1000;
                
                if (remainingTime <= 0) {
                    redirectToLogin('Session expired');
                    return;
                }
                
                const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                
                timerDisplay.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Warning when less than 10 minutes
                if (remainingTime < 10 * 60 * 1000) {
                    timerDisplay.style.color = '#dc3545';
                    sessionInfo.textContent = 'Session expiring soon';
                    sessionInfo.style.color = '#dc3545';
                }
                
                // Warning when less than 5 minutes
                if (remainingTime < 5 * 60 * 1000) {
                    timerDisplay.classList.add('timer-warning');
                    if (remainingTime % 2000 < 1000) {
                        timerDisplay.style.opacity = '0.5';
                    } else {
                        timerDisplay.style.opacity = '1';
                    }
                }
            }
            
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        // Initialize session validation
        if (!validateSession()) {
            // Will redirect if invalid
        }

        // Load products from localStorage or use defaults
        let products = [];

        function loadProducts() {
            const storedProducts = localStorage.getItem('products');
            if (storedProducts) {
                products = JSON.parse(storedProducts);
            } else {
                // Default products
                products = [
                    { id: 1, name: 'Rice (1kg)', price: 80, category: 'grocery', available: true },
                    { id: 2, name: 'Wheat Flour (1kg)', price: 45, category: 'grocery', available: true },
                    { id: 3, name: 'Sugar (1kg)', price: 50, category: 'grocery', available: true },
                    { id: 4, name: 'Tea Powder (250g)', price: 120, category: 'grocery', available: true },
                    { id: 5, name: 'Biscuits', price: 25, category: 'snacks', available: true },
                    { id: 6, name: 'Chips', price: 20, category: 'snacks', available: false },
                    { id: 7, name: 'Detergent (1kg)', price: 180, category: 'household', available: true },
                    { id: 8, name: 'Soap', price: 35, category: 'household', available: true },
                    { id: 9, name: 'Cold Drink (500ml)', price: 40, category: 'beverages', available: true },
                    { id: 10, name: 'Water Bottle (1L)', price: 20, category: 'beverages', available: true }
                ];
                saveProducts();
            }
            displayProducts();
            updateStats();
        }

        function saveProducts() {
            localStorage.setItem('products', JSON.stringify(products));
        }

        function displayProducts() {
            const tbody = document.getElementById('products-tbody');
            const noProductsDiv = document.getElementById('no-products-admin');
            
            if (products.length === 0) {
                tbody.innerHTML = '';
                noProductsDiv.style.display = 'block';
                return;
            }
            
            noProductsDiv.style.display = 'none';
            
            tbody.innerHTML = products.map(product => {
                const imageUrl = product.imageUrl || getDefaultProductImage(product.name, product.category);
                const variantsCount = product.priceVariants ? product.priceVariants.length : 0;
                const variantsText = variantsCount > 0 ? `${variantsCount} variants` : 'No variants';
                
                return `
                <tr>
                    <td>
                        <img src="${imageUrl}" alt="${product.name}" class="product-thumb" 
                             onerror="this.src='https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=50&h=50&fit=crop&auto=format&q=80'">
                    </td>
                    <td>${product.id}</td>
                    <td>
                        <div class="product-name-cell">
                            <strong>${product.name}</strong>
                            ${product.description ? `<br><small class="product-desc">${product.description}</small>` : ''}
                        </div>
                    </td>
                    <td>‚Çπ${product.price}</td>
                    <td>${capitalizeFirst(product.category)}</td>
                    <td>
                        <span class="variants-badge" title="${variantsCount > 0 ? product.priceVariants.map(v => `${v.size}: ‚Çπ${v.price}`).join(', ') : 'No price variants'}">
                            ${variantsText}
                        </span>
                    </td>
                    <td class="${product.available ? 'status-available' : 'status-unavailable'}">
                        ${product.available ? 'Available' : 'Out of Stock'}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="editProduct(${product.id})" title="Edit Product">‚úèÔ∏è</button>
                            <button class="btn-toggle" onclick="toggleAvailability(${product.id})" title="Toggle Availability">
                                ${product.available ? '‚ùå' : '‚úÖ'}
                            </button>
                            <button class="delete-btn" onclick="deleteProduct(${product.id})" title="Delete Product">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function getDefaultProductImage(productName, category) {
            // Use the same logic as in products.html
            const productImages = {
                "Rice": "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=50&h=50&fit=crop&auto=format&q=80",
                "Wheat Flour": "https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=50&h=50&fit=crop&auto=format&q=80",
                "Sugar": "https://images.unsplash.com/photo-1599599810769-bcde5a160d32?w=50&h=50&fit=crop&auto=format&q=80",
                "Tea Powder": "https://images.unsplash.com/photo-1576092768241-dec231879fc3?w=50&h=50&fit=crop&auto=format&q=80",
                "Biscuits": "https://images.unsplash.com/photo-1558961363-fa8fdf82db35?w=50&h=50&fit=crop&auto=format&q=80",
                "Chips": "https://images.unsplash.com/photo-1566478989037-eec170784d0b?w=50&h=50&fit=crop&auto=format&q=80",
                "Detergent": "https://images.unsplash.com/photo-1583947215259-38e31be8751f?w=50&h=50&fit=crop&auto=format&q=80",
                "Soap": "https://images.unsplash.com/photo-1556228720-195a672e8a03?w=50&h=50&fit=crop&auto=format&q=80",
                "Cold Drink": "https://images.unsplash.com/photo-1581636625402-29b2a704ef13?w=50&h=50&fit=crop&auto=format&q=80",
                "Water Bottle": "https://images.unsplash.com/photo-1523362628745-0c100150b504?w=50&h=50&fit=crop&auto=format&q=80"
            };
            
            for (const [key, value] of Object.entries(productImages)) {
                if (productName.toLowerCase().includes(key.toLowerCase())) {
                    return value;
                }
            }
            
            return "https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=50&h=50&fit=crop&auto=format&q=80";
        }

        function updateStats() {
            const totalProducts = products.length;
            const availableProducts = products.filter(p => p.available).length;
            const outOfStock = products.filter(p => !p.available).length;
            
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('available-products').textContent = availableProducts;
            document.getElementById('out-of-stock').textContent = outOfStock;
        }

        function addProduct(productData) {
            const newProduct = {
                id: Date.now(),
                name: productData.name,
                price: parseFloat(productData.price),
                category: productData.category,
                available: productData.available === 'true',
                imageUrl: productData.imageUrl || null,
                description: productData.description || null,
                priceVariants: productData.priceVariants || null
            };
            products.push(newProduct);
            saveProducts();
            displayProducts();
            updateStats();
            return newProduct;
        }

        function deleteProduct(id, confirm = true) {
            if (!confirm || window.confirm('Are you sure you want to delete this product?')) {
                products = products.filter(product => product.id !== parseInt(id));
                saveProducts();
                displayProducts();
                updateStats();
            }
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear all session data
                sessionStorage.clear();
                localStorage.removeItem('loginAttempts');
                localStorage.removeItem('lockoutTime');
                
                // Show logout message
                alert('Logged out successfully!');
                window.location.href = 'admin.html';
            }
        }

        // Auto-save functionality
        let autoSaveInterval;
        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                const products = JSON.parse(localStorage.getItem('products') || '[]');
                const backup = {
                    products: products,
                    timestamp: Date.now(),
                    user: sessionStorage.getItem('adminUser')
                };
                localStorage.setItem('productsBackup', JSON.stringify(backup));
            }, 5 * 60 * 1000); // Auto-save every 5 minutes
        }

        // Activity monitoring
        let lastActivity = Date.now();
        function updateActivity() {
            lastActivity = Date.now();
        }

        // Monitor user activity
        ['click', 'keypress', 'mousemove'].forEach(event => {
            document.addEventListener(event, updateActivity);
        });

        // Check for inactivity
        setInterval(() => {
            const inactiveTime = Date.now() - lastActivity;
            const INACTIVE_LIMIT = 30 * 60 * 1000; // 30 minutes
            
            if (inactiveTime > INACTIVE_LIMIT) {
                alert('Session expired due to inactivity.');
                logout();
            }
        }, 60000); // Check every minute

        function exportProducts() {
            const dataStr = JSON.stringify(products, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'products.json';
            link.click();
        }

        function clearAllProducts() {
            if (confirm('Are you sure you want to delete all products? This action cannot be undone.')) {
                products = [];
                saveProducts();
                displayProducts();
                updateStats();
            }
        }

        function resetToDefaults() {
            if (confirm('Reset to default products? This will replace all current products.')) {
                localStorage.removeItem('products');
                loadProducts();
            }
        }

        // Price variants management
        function addVariant() {
            const container = document.getElementById('price-variants-container');
            const variantRow = document.createElement('div');
            variantRow.className = 'variant-row';
            variantRow.innerHTML = `
                <div class="form-group">
                    <label>Size/Quantity</label>
                    <input type="text" name="variant-size" placeholder="e.g., 500g, 1kg, Small Pack">
                </div>
                <div class="form-group">
                    <label>Price (‚Çπ)</label>
                    <input type="number" name="variant-price" min="0" step="0.01" placeholder="0.00">
                </div>
                <button type="button" class="btn-remove-variant" onclick="removeVariant(this)">√ó</button>
            `;
            container.appendChild(variantRow);
        }

        function removeVariant(button) {
            const variantRow = button.parentElement;
            variantRow.remove();
        }

        function collectPriceVariants() {
            const variants = [];
            const variantRows = document.querySelectorAll('.variant-row');
            
            variantRows.forEach(row => {
                const size = row.querySelector('input[name="variant-size"]').value.trim();
                const price = row.querySelector('input[name="variant-price"]').value;
                
                if (size && price) {
                    variants.push({
                        size: size,
                        price: parseFloat(price)
                    });
                }
            });
            
            return variants.length > 0 ? variants : null;
        }

        function previewProduct() {
            const formData = new FormData(document.getElementById('add-product-form'));
            const productData = {
                name: formData.get('name'),
                price: formData.get('price'),
                category: formData.get('category'),
                imageUrl: formData.get('imageUrl'),
                description: formData.get('description'),
                available: formData.get('available'),
                priceVariants: collectPriceVariants()
            };

            const previewHtml = `
                <div class="product-preview">
                    <h3>Product Preview</h3>
                    <div class="preview-content">
                        <img src="${productData.imageUrl || getDefaultProductImage(productData.name, productData.category)}" 
                             alt="${productData.name}" class="preview-image"
                             onerror="this.src='https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=200&h=150&fit=crop&auto=format&q=80'">
                        <div class="preview-details">
                            <h4>${productData.name}</h4>
                            <p><strong>Price:</strong> ‚Çπ${productData.price}</p>
                            <p><strong>Category:</strong> ${capitalizeFirst(productData.category)}</p>
                            <p><strong>Status:</strong> ${productData.available === 'true' ? 'Available' : 'Out of Stock'}</p>
                            ${productData.description ? `<p><strong>Description:</strong> ${productData.description}</p>` : ''}
                            ${productData.priceVariants ? `
                                <div class="preview-variants">
                                    <strong>Price Variants:</strong>
                                    <ul>
                                        ${productData.priceVariants.map(v => `<li>${v.size}: ‚Çπ${v.price}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    ${previewHtml}
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="closePreview()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closePreview() {
            const modal = document.querySelector('.preview-modal');
            if (modal) modal.remove();
        }

        function toggleAvailability(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                product.available = !product.available;
                saveProducts();
                displayProducts();
                updateStats();
            }
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                // Fill form with product data
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-category').value = product.category;
                document.getElementById('product-image').value = product.imageUrl || '';
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-status').value = product.available.toString();

                // Clear existing variants and add product variants
                const container = document.getElementById('price-variants-container');
                container.innerHTML = '';
                
                if (product.priceVariants && product.priceVariants.length > 0) {
                    product.priceVariants.forEach(variant => {
                        addVariant();
                        const lastRow = container.lastElementChild;
                        lastRow.querySelector('input[name="variant-size"]').value = variant.size;
                        lastRow.querySelector('input[name="variant-price"]').value = variant.price;
                    });
                } else {
                    addVariant(); // Add one empty variant row
                }

                // Delete the product (it will be re-added when form is submitted)
                deleteProduct(id, false);
                
                // Scroll to form
                document.querySelector('.dashboard-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Form submission
        document.getElementById('add-product-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const productData = {
                name: formData.get('name'),
                price: formData.get('price'),
                category: formData.get('category'),
                imageUrl: formData.get('imageUrl'),
                description: formData.get('description'),
                available: formData.get('available'),
                priceVariants: collectPriceVariants()
            };
            
            if (productData.name && productData.price && productData.category) {
                addProduct(productData);
                this.reset();
                
                // Reset variants container
                const container = document.getElementById('price-variants-container');
                container.innerHTML = `
                    <div class="variant-row">
                        <div class="form-group">
                            <label>Size/Quantity</label>
                            <input type="text" name="variant-size" placeholder="e.g., 500g, 1kg, Small Pack">
                        </div>
                        <div class="form-group">
                            <label>Price (‚Çπ)</label>
                            <input type="number" name="variant-price" min="0" step="0.01" placeholder="0.00">
                        </div>
                        <button type="button" class="btn-remove-variant" onclick="removeVariant(this)">√ó</button>
                    </div>
                `;
                
                alert('Product added successfully!');
            }
        });

        // Production Ready Features
        function addProductionFeatures() {
            // Add production badge
            const badge = document.createElement('div');
            badge.className = 'production-badge';
            badge.textContent = 'üöÄ Production Ready';
            document.body.appendChild(badge);
            
            // Add backup indicator
            const backupIndicator = document.createElement('div');
            backupIndicator.className = 'backup-indicator';
            backupIndicator.innerHTML = 'üíæ';
            backupIndicator.title = 'Auto-backup active';
            document.body.appendChild(backupIndicator);
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 's':
                            e.preventDefault();
                            exportProducts();
                            break;
                        case 'n':
                            e.preventDefault();
                            document.getElementById('product-name').focus();
                            break;
                        case 'l':
                            e.preventDefault();
                            if (confirm('Logout?')) logout();
                            break;
                    }
                }
            });
            
            // Add tooltips for shortcuts
            const shortcuts = document.createElement('div');
            shortcuts.innerHTML = `
                <div style="position: fixed; bottom: 60px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 1rem; border-radius: 8px; font-size: 0.8rem; z-index: 1000;">
                    <div><strong>Shortcuts:</strong></div>
                    <div>Ctrl+S: Export</div>
                    <div>Ctrl+N: New Product</div>
                    <div>Ctrl+L: Logout</div>
                </div>
            `;
            shortcuts.style.display = 'none';
            shortcuts.id = 'shortcuts-help';
            document.body.appendChild(shortcuts);
            
            // Toggle shortcuts help
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F1') {
                    e.preventDefault();
                    const help = document.getElementById('shortcuts-help');
                    help.style.display = help.style.display === 'none' ? 'block' : 'none';
                }
            });
        }

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            console.error('Admin Panel Error:', e.error);
            // In production, you might want to send this to a logging service
        });

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            startAutoSave();
            addProductionFeatures();
        });
    </script>
</body>
</html>